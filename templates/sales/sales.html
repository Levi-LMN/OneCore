{% extends "base.html" %}
{% block title %}Sales - Liquor Store Management{% endblock %}
{% block page_title %}Sales Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Sales Management</h2>
            <div class="d-flex align-items-center">
                <label for="dateSelect" class="form-label me-2">Date:</label>
                <input type="date" class="form-control me-3" id="dateSelect" value="{{ selected_date.strftime('%Y-%m-%d') }}"
                       onchange="window.location.href='{{ url_for('sales') }}?date=' + this.value">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSaleModal">
                    <i class="fas fa-plus me-2"></i>New Sale
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sales Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h6>Total Sales</h6>
                <h4>{{ format_currency(total_sales) }}</h4>
            </div>
        </div>
    </div>
    {% if current_user.role in ['admin', 'manager'] %}
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h6>Total Profit</h6>
                <h4>{{ format_currency(total_profit) }}</h4>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h6>Discounts Given</h6>
                <h4>{{ format_currency(total_discount) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <h6>Original Amount</h6>
                <h4>{{ format_currency(total_original) }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Sales Table -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list me-2"></i>Sales for {{ selected_date.strftime('%B %d, %Y') }}</h5>
    </div>
    <div class="card-body">
        {% if sales_data %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Original</th>
                        <th>Discount</th>
                        <th>Total</th>
                        <th>Payment</th>
                        <th>Attendant</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale, variant, product, user, category, size in sales_data %}
                    <tr>
                        <td>{{ sale.timestamp.strftime('%H:%M') }}</td>
                        <td>
                            <strong>{{ product.name }}</strong><br>
                            <small class="text-muted">{{ size.name }}</small>
                        </td>
                        <td>{{ sale.quantity }}</td>
                        <td>{{ format_currency(sale.unit_price) }}</td>
                        <td>{{ format_currency(sale.original_amount) }}</td>
                        <td>
                            {% if sale.discount_amount > 0 %}
                                <span class="text-warning">-{{ format_currency(sale.discount_amount) }}</span>
                                {% if sale.discount_reason %}
                                <br><small class="text-muted">{{ sale.discount_reason }}</small>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td><strong>{{ format_currency(sale.total_amount) }}</strong></td>
                        <td>
                            <small>
                                {% if sale.cash_amount > 0 %}Cash: {{ format_currency(sale.cash_amount) }}<br>{% endif %}
                                {% if sale.mpesa_amount > 0 %}M-Pesa: {{ format_currency(sale.mpesa_amount) }}<br>{% endif %}
                                {% if sale.credit_amount > 0 %}Credit: {{ format_currency(sale.credit_amount) }}{% endif %}
                            </small>
                        </td>
                        <td>{{ user.full_name }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if current_user.role in ['admin', 'manager'] or sale.attendant_id == current_user.id %}
                                <a href="{{ url_for('edit_sale', sale_id=sale.id) }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="POST" action="{{ url_for('delete_sale', sale_id=sale.id) }}" style="display: inline;"
                                      onsubmit="return confirm('Are you sure you want to delete this sale?')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-muted py-4">No sales recorded for this date</p>
        {% endif %}
    </div>
</div>

<!-- Add Sale Modal -->
<div class="modal fade" id="addSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record New Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_sale') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="variant_id" class="form-label">Product Variant</label>
                                <select class="form-select" id="variant_id" name="variant_id" required>
                                    <option value="">Select product variant</option>
                                    {% for variant, product, category, size in variants %}
                                    <option value="{{ variant.id }}" data-price="{{ variant.selling_price }}" data-available="{{ variant.get_available_stock_in_variant_units() }}">
                                        {{ product.name }} - {{ size.name }} ({{ format_currency(variant.selling_price) }})
                                        - Available: {{ variant.get_available_stock_in_variant_units() }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" min="1" step="0.5" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="unit_price" class="form-label">Unit Price</label>
                                <input type="number" class="form-control" id="unit_price" name="unit_price" step="0.01" required readonly>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="discount_type" class="form-label">Discount Type</label>
                                <select class="form-select" id="discount_type" name="discount_type">
                                    <option value="none">No Discount</option>
                                    <option value="percentage">Percentage Discount</option>
                                    <option value="fixed">Fixed Amount Discount</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="discount_value" class="form-label">Discount Value</label>
                                <input type="number" class="form-control" id="discount_value" name="discount_value" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="discount_reason" class="form-label">Discount Reason</label>
                                <input type="text" class="form-control" id="discount_reason" name="discount_reason" placeholder="Optional">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cash_amount" class="form-label">Cash Amount</label>
                                <input type="number" class="form-control" id="cash_amount" name="cash_amount" step="0.01" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="mpesa_amount" class="form-label">M-Pesa Amount</label>
                                <input type="number" class="form-control" id="mpesa_amount" name="mpesa_amount" step="0.01" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="credit_amount" class="form-label">Credit Amount</label>
                                <input type="number" class="form-control" id="credit_amount" name="credit_amount" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customer_name" class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" placeholder="Required for credit sales">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sale_date" class="form-label">Sale Date</label>
                                <input type="date" class="form-control" id="sale_date" name="sale_date" value="{{ today.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Optional notes"></textarea>
                    </div>

                    <div class="alert alert-info" id="saleCalculation" style="display: none;">
                        <strong>Sale Summary:</strong>
                        <div id="calculationDetails"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Sale</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Sales modal calculation
document.addEventListener('DOMContentLoaded', function() {
    const variantSelect = document.getElementById('variant_id');
    const quantityInput = document.getElementById('quantity');
    const unitPriceInput = document.getElementById('unit_price');
    const discountTypeSelect = document.getElementById('discount_type');
    const discountValueInput = document.getElementById('discount_value');
    const cashInput = document.getElementById('cash_amount');
    const mpesaInput = document.getElementById('mpesa_amount');
    const creditInput = document.getElementById('credit_amount');
    const calculationDiv = document.getElementById('saleCalculation');
    const calculationDetails = document.getElementById('calculationDetails');

    // Update unit price when variant changes
    if (variantSelect) {
        variantSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                unitPriceInput.value = selectedOption.dataset.price;
                calculateSale();
            }
        });
    }

    // Calculate sale totals
    function calculateSale() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        const discountType = discountTypeSelect.value;
        const discountValue = parseFloat(discountValueInput.value) || 0;

        if (quantity > 0 && unitPrice > 0) {
            const originalAmount = quantity * unitPrice;
            let discountAmount = 0;

            if (discountType === 'percentage') {
                discountAmount = (originalAmount * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discountAmount = Math.min(discountValue, originalAmount);
            }

            const totalAmount = originalAmount - discountAmount;

            calculationDetails.innerHTML = `
                Original Amount: ${originalAmount.toFixed(2)}<br>
                Discount: -${discountAmount.toFixed(2)}<br>
                <strong>Total: ${totalAmount.toFixed(2)}</strong>
            `;
            calculationDiv.style.display = 'block';

            // Auto-fill cash amount if no payment specified
            const totalPayment = parseFloat(cashInput.value || 0) + parseFloat(mpesaInput.value || 0) + parseFloat(creditInput.value || 0);
            if (totalPayment === 0) {
                cashInput.value = totalAmount.toFixed(2);
            }
        } else {
            calculationDiv.style.display = 'none';
        }
    }

    // Attach event listeners
    [quantityInput, unitPriceInput, discountValueInput].forEach(input => {
        if (input) input.addEventListener('input', calculateSale);
    });

    if (discountTypeSelect) {
        discountTypeSelect.addEventListener('change', calculateSale);
    }
});
</script>
{% endblock %}