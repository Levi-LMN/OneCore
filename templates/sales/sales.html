<!-- sales/sales.html -->
{% extends "base.html" %}

{% block title %}Sales - LiquorPro{% endblock %}
{% block page_title %}Point of Sale{% endblock %}
{% block breadcrumb %}Sales / POS{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h5>Sales Management</h5>
                <small class="text-muted">Date: {{ selected_date.strftime('%A, %B %d, %Y') }}</small>
            </div>
            <form method="GET" action="{{ url_for('sales') }}" class="d-flex gap-2">
                <input type="date" class="form-control form-control-sm" name="date"
                       value="{{ selected_date.strftime('%Y-%m-%d') }}"
                       max="{{ today.strftime('%Y-%m-%d') }}">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-filter"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <small class="text-muted">Original Amount</small>
                <h4 class="mb-0">{{ format_currency(total_original) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <small class="text-muted">Discounts</small>
                <h4 class="mb-0 text-danger">-{{ format_currency(total_discount) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <small class="text-muted">Total Sales</small>
                <h4 class="mb-0 text-success">{{ format_currency(total_sales) }}</h4>
            </div>
        </div>
    </div>
    {% if current_user.role in ['admin', 'manager'] %}
    <div class="col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <small class="text-muted">Profit</small>
                <h4 class="mb-0 text-primary">{{ format_currency(total_profit) }}</h4>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Sale Form -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Record New Sale</h6>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('add_sale') }}" id="saleForm">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Product Variant *</label>
                    <select class="form-select" name="variant_id" id="variant_id" required>
                        <option value="">Select Product Variant</option>
                        {% for variant, product, category, size in variants %}
                        <option value="{{ variant.id }}"
                                data-price="{{ variant.selling_price }}"
                                data-available="{{ variant.get_available_stock_in_variant_units() }}"
                                data-product="{{ product.name }}"
                                data-size="{{ size.name }}">
                            {{ product.name }} - {{ size.name }} ({{ format_currency(variant.selling_price) }})
                            [{{ variant.get_available_stock_in_variant_units() }} available]
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Quantity *</label>
                    <input type="number" class="form-control" name="quantity" id="quantity" step="1" min="1" value="1" required>
                    <small class="text-muted" id="availableStock"></small>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Unit Price *</label>
                    <input type="number" class="form-control" name="unit_price" id="unit_price" step="0.01" min="0" readonly required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Total</label>
                    <input type="text" class="form-control" id="total_display" readonly>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Sale Date *</label>
                    <input type="date" class="form-control" name="sale_date" value="{{ selected_date.strftime('%Y-%m-%d') }}" max="{{ today.strftime('%Y-%m-%d') }}" required>
                </div>
            </div>

            <!-- Discount Section -->
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Discount Type</label>
                    <select class="form-select" name="discount_type" id="discount_type">
                        <option value="none">No Discount</option>
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (KES)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Discount Value</label>
                    <input type="number" class="form-control" name="discount_value" id="discount_value" step="0.01" min="0" value="0">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Discount Reason</label>
                    <input type="text" class="form-control" name="discount_reason" id="discount_reason" placeholder="Required if discount > 0">
                </div>
            </div>

            <!-- Payment Section -->
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Cash Amount</label>
                    <input type="number" class="form-control" name="cash_amount" id="cash_amount" step="0.01" min="0" value="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">M-Pesa Amount</label>
                    <input type="number" class="form-control" name="mpesa_amount" id="mpesa_amount" step="0.01" min="0" value="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Credit Amount</label>
                    <input type="number" class="form-control" name="credit_amount" id="credit_amount" step="0.01" min="0" value="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Customer Name</label>
                    <input type="text" class="form-control" name="customer_name" placeholder="Required for credit">
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-12">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" name="notes" rows="2" placeholder="Optional notes"></textarea>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check me-2"></i>Record Sale
                </button>
                <button type="reset" class="btn btn-secondary">
                    <i class="fas fa-redo me-2"></i>Reset
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Sales List -->
<div class="card shadow-sm">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Today's Sales ({{ sales_data|length }} transactions)</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Original</th>
                        <th>Discount</th>
                        <th>Total</th>
                        <th>Payment</th>
                        {% if current_user.role in ['admin', 'manager'] %}
                        <th>Profit</th>
                        <th>Attendant</th>
                        {% endif %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale, variant, product, user, category, size in sales_data %}
                    <tr>
                        <td>{{ sale.timestamp.strftime('%I:%M %p') }}</td>
                        <td>
                            <strong>{{ product.name }}</strong><br>
                            <small class="text-muted">{{ size.name }}</small>
                        </td>
                        <td>{{ sale.quantity }}</td>
                        <td>{{ format_currency(sale.unit_price) }}</td>
                        <td>{{ format_currency(sale.original_amount) }}</td>
                        <td>
                            {% if sale.discount_amount > 0 %}
                            <span class="text-danger">-{{ format_currency(sale.discount_amount) }}</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td><strong>{{ format_currency(sale.total_amount) }}</strong></td>
                        <td>
                            <small>
                                {% if sale.cash_amount > 0 %}Cash: {{ format_currency(sale.cash_amount) }}<br>{% endif %}
                                {% if sale.mpesa_amount > 0 %}M-Pesa: {{ format_currency(sale.mpesa_amount) }}<br>{% endif %}
                                {% if sale.credit_amount > 0 %}Credit: {{ format_currency(sale.credit_amount) }}{% endif %}
                            </small>
                        </td>
                        {% if current_user.role in ['admin', 'manager'] %}
                        <td class="text-success">{{ format_currency(sale.get_profit()) }}</td>
                        <td><small>{{ user.full_name }}</small></td>
                        {% endif %}
                        <td>
                            <a href="{{ url_for('edit_sale', sale_id=sale.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST" action="{{ url_for('delete_sale', sale_id=sale.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this sale?')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if not sales_data %}
<div class="alert alert-info mt-3">
    <i class="fas fa-info-circle me-2"></i>No sales recorded for this date.
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const variantSelect = document.getElementById('variant_id');
    const quantityInput = document.getElementById('quantity');
    const unitPriceInput = document.getElementById('unit_price');
    const totalDisplay = document.getElementById('total_display');
    const availableStock = document.getElementById('availableStock');
    const discountType = document.getElementById('discount_type');
    const discountValue = document.getElementById('discount_value');

    function updateCalculations() {
        const selectedOption = variantSelect.options[variantSelect.selectedIndex];
        if (selectedOption.value) {
            const price = parseFloat(selectedOption.dataset.price);
            const available = parseInt(selectedOption.dataset.available);
            const quantity = parseFloat(quantityInput.value) || 0;

            unitPriceInput.value = price.toFixed(2);
            availableStock.textContent = `${available} available`;

            // Calculate total with discount
            let total = price * quantity;
            const discType = discountType.value;
            const discVal = parseFloat(discountValue.value) || 0;

            if (discType === 'percentage') {
                total = total - (total * discVal / 100);
            } else if (discType === 'fixed') {
                total = total - discVal;
            }

            totalDisplay.value = 'KES ' + Math.max(0, total).toFixed(2);

            // Validate quantity
            if (quantity > available) {
                quantityInput.setCustomValidity(`Only ${available} units available`);
            } else {
                quantityInput.setCustomValidity('');
            }
        }
    }

    variantSelect.addEventListener('change', updateCalculations);
    quantityInput.addEventListener('input', updateCalculations);
    discountType.addEventListener('change', updateCalculations);
    discountValue.addEventListener('input', updateCalculations);
});
</script>
{% endblock %}

